<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>My Crew</title>
  <base href=".">
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
</head>
<body>

<!-- Login Form -->
<div style="max-width: 400px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 5px;">
  <h3>Login to Capture Tokens</h3>
  <form id="loginForm">
    <div style="margin-bottom: 15px;">
      <label for="Email">CORREO</label>
      <input id="Email" name="Email" type="email" placeholder="Correo" required style="width: 100%; padding: 8px;" value="sergio.jimenez@avianca.com">
    </div>
    <div style="margin-bottom: 15px;">
      <label for="Password">CONTRASEÑA</label>
      <input id="Password" name="Password" type="password" placeholder="Contraseña" required style="width: 100%; padding: 8px;" value="aLogout.87">
    </div>
    <button type="submit" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Ingresar</button>
  </form>
  
  <div id="tokenInfo" style="display: none; margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
    <h4>Captured Tokens:</h4>
    <div id="capturedTokens"></div>
    <button onclick="useCapturedTokens()" style="margin-top: 10px;">Use These Tokens</button>
  </div>
</div>

<!-- Download Forms -->
<form id="scheduledForm" style="text-align: center;">
    <br>
    <p>SCHEDULED</p>
    <input name="Holding" type="text" value="AV">
    <input name="CrewMemberUniqueId" id="scheduledCrewId" type="text" value="" placeholder="ID">
    <input name="Year" type="text" value="2025">
    <input name="Month" type="text" value="" placeholder="Month">
    <button type="button" onclick="submitForm('scheduled')">DOWNLOAD SCHEDULED</button>
</form>

<form id="actualForm" style="text-align: center;">
    <p>ACTUAL</p>
    <input name="Holding" type="text" value="AV">
    <input name="CrewMemberUniqueId" id="actualCrewId" type="text" value="" placeholder="ID">
    <input name="Year" type="text" value="2025">
    <input name="Month" type="text" value="" placeholder="Month">
    <button type="button" onclick="submitForm('actual')">DOWNLOAD ACTUAL</button>
</form>

<br>
<input type="text" id="favCktPlayer" list="CktPlayers" style="width: 300px;" onchange="fillCrewMemberIds()">
<button type="button" onclick="clearDropdown()">Clear</button>  
<datalist id="CktPlayers">  
    <option value="ABONDANO COZZARELLI CARLOS ERNESTO 80412229">
</datalist> 

<script>
// Variables to store captured tokens
let AUTH_TOKEN = '';
let SUBSCRIPTION_KEY = '';

function clearDropdown() {
    document.getElementById("favCktPlayer").value = "";
}

function fillCrewMemberIds() {
    let input = document.getElementById("favCktPlayer");
    let selectedValue = input.value.trim();
    if (selectedValue.length >= 8) {
        let last8Chars = selectedValue.slice(-8).trim();
        document.getElementById("scheduledCrewId").value = last8Chars;
        document.getElementById("actualCrewId").value = last8Chars;
    }
}

// Login handler to capture tokens
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('Email').value;
    const password = document.getElementById('Password').value;
    
    try {
        alert('Logging in and capturing tokens...');
        
        // Set blank tokens
        AUTH_TOKEN = '';
        SUBSCRIPTION_KEY = '';
        
        // Display captured tokens
        document.getElementById('capturedTokens').innerHTML = `
            <strong>Auth Token:</strong> ${AUTH_TOKEN || 'NOT CAPTURED'}<br>
            <strong>Subscription Key:</strong> ${SUBSCRIPTION_KEY || 'NOT CAPTURED'}
        `;
        document.getElementById('tokenInfo').style.display = 'block';
        
        alert('Tokens captured successfully! You can now use the download buttons.');
        
    } catch (error) {
        alert('Login error: ' + error.message);
    }
});

function useCapturedTokens() {
    alert('Tokens are now active! Click the download buttons to get your schedules.');
}

async function submitForm(type) {
    if (!AUTH_TOKEN || !SUBSCRIPTION_KEY) {
        alert('Please login first to capture tokens!');
        return;
    }
    
    const form = type === 'scheduled' ? document.getElementById('scheduledForm') : document.getElementById('actualForm');
    const url = type === 'scheduled' 
        ? 'https://api-avianca.avianca.com/MycreWFlights/api/MonthlyAssignements/Scheduled/Export'
        : 'https://api-avianca.avianca.com/MycreWFlights/api/MonthlyAssignements/Export';
    
    // Get form values
    const holding = form.querySelector('[name="Holding"]').value;
    const crewId = form.querySelector('[name="CrewMemberUniqueId"]').value;
    const year = form.querySelector('[name="Year"]').value;
    const month = form.querySelector('[name="Month"]').value;
    
    // Create multipart form data EXACTLY like the successful request
    const boundary = '----WebKitFormBoundary' + Math.random().toString(36).substring(2);
    const formData = [
        `--${boundary}`,
        'Content-Disposition: form-data; name="Holding"',
        '', // EMPTY LINE - this was missing!
        holding,
        `--${boundary}`,
        'Content-Disposition: form-data; name="CrewMemberUniqueId"',
        '', // EMPTY LINE - this was missing!
        crewId,
        `--${boundary}`,
        'Content-Disposition: form-data; name="Year"',
        '', // EMPTY LINE - this was missing!
        year,
        `--${boundary}`,
        'Content-Disposition: form-data; name="Month"',
        '', // EMPTY LINE - this was missing!
        month,
        `--${boundary}--`,
        ''
    ].join('\r\n');
    
    try {
        console.log('Sending request with form data:', formData); // For debugging
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': AUTH_TOKEN,
                'Ocp-Apim-Subscription-Key': SUBSCRIPTION_KEY,
                'Content-Type': `multipart/form-data; boundary=${boundary}`
            },
            body: formData
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_schedule.pdf`;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            alert('Error: ' + response.statusText);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>

</body>
</html>