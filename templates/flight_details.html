<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLIGHT SEARCH - Crew Schedule Monitor</title>
    <style>
        /* ... (keep all your existing CSS styles) ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FLIGHT SEARCH</h1>
            <div class="crew-info">
                <strong>Current Crew ID:</strong> {{ current_crew_id }}
            </div>
        </div>

        <div class="nav-buttons">
            <a href="/" class="nav-button">Schedule View</a>
            <a href="/calendar" class="nav-button">Calendar View</a>
            <a href="/pdf" class="nav-button">PDF Download</a>
            <a href="/flight_details" class="nav-button active">Flight Search</a>
        </div>

        <div class="content-section">
            <!-- ALWAYS show search form -->
            <form id="flightSearchForm">
                <div class="search-form-grid">
                    <!-- COLUMN 1, ROW 1: Flight Number -->
                    <div class="form-group">
                        <label for="flight_number">Flight Number *</label>
                        <input type="text" id="flight_number" name="flight_number" required placeholder="e.g., 210">
                    </div>

                    <!-- COLUMN 2, ROW 1: Departure Date -->
                    <div class="form-group">
                        <label for="departure_date">Departure Date *</label>
                        <input type="date" id="departure_date" name="departure_date" required>
                    </div>

                    <!-- COLUMN 1, ROW 2: Origin Airport -->
                    <div class="form-group">
                        <label for="origin_airport">Origin Airport (IATA) *</label>
                        <input type="text" id="origin_airport" name="origin_airport" required value="BOG" maxlength="3">
                    </div>

                    <!-- COLUMN 2, ROW 2: Clear and Search Buttons -->
                    <div class="search-buttons">
                        <button type="button" class="clear-origin-btn" onclick="clearOriginAirport()">Clear</button>
                        <button type="submit" class="btn" id="searchBtn">
                            Search Flight
                        </button>
                    </div>
                </div>
            </form>

            <div id="loading" class="loading hidden">
                <div>Fetching flight details...</div>
            </div>

            <!-- Auto-display flight data if available -->
            {% if auto_fetch and flight_details %}
                <div id="flightDetails">
                    <!-- Flight details will be displayed here by JavaScript -->
                </div>
                <script>
                    // Immediately display the flight data that was fetched server-side
                    document.addEventListener('DOMContentLoaded', function() {
                        // Set currentFlightData for crew and previous flight loading
                        const urlParams = new URLSearchParams(window.location.search);
                        const flightNumber = urlParams.get('flight_number');
                        const localDate = urlParams.get('local_date');
                        const originAirport = urlParams.get('origin_airport');
                        
                        if (flightNumber && localDate && originAirport) {
                            currentFlightData = {
                                airline: 'AV',
                                flight_number: flightNumber,
                                departure_date: localDate + 'T00:00:00Z',
                                origin_airport: originAirport,
                                operational_number: '42307372'
                            };
                        }
                        
                        displayFlightDetails({{ flight_details | tojson }});
                        {% if crew_data %}
                        displayCrewMembers({{ crew_data | tojson }});
                        {% else %}
                        // Load crew members if not already loaded
                        setTimeout(() => {
                            loadCrewMembers();
                        }, 500);
                        {% endif %}
                        
                        // Auto-scroll to flight details
                        setTimeout(() => {
                            const flightDetails = document.getElementById('flightDetails');
                            if (flightDetails) {
                                flightDetails.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    });
                </script>
            {% elif auto_fetch and not flight_details %}
                <div class="error-message">
                    Failed to fetch flight details for {{ flight_number }} on {{ local_date }} from {{ origin_airport }}
                </div>
            {% else %}
                <!-- Manual search results section -->
                <div id="resultsSection" class="hidden">
                    <div id="flightDetails"></div>
                </div>
            {% endif %}

            <div id="errorMessage" class="error-message hidden"></div>
        </div>
    </div>

    <script>
        document.getElementById('departure_date').value = new Date().toISOString().slice(0, 10);
        let currentFlightData = null;

        // Auto-fill form if URL parameters are present
        const urlParams = new URLSearchParams(window.location.search);
        const flightNumber = urlParams.get('flight_number');
        const localDate = urlParams.get('local_date');
        const originAirport = urlParams.get('origin_airport');
        
        if (flightNumber && localDate && originAirport) {
            document.getElementById('flight_number').value = flightNumber;
            document.getElementById('departure_date').value = localDate;
            document.getElementById('origin_airport').value = originAirport;
            
            // Set currentFlightData for manual searches later
            currentFlightData = {
                airline: 'AV',
                flight_number: flightNumber,
                departure_date: localDate + 'T00:00:00Z',
                origin_airport: originAirport,
                operational_number: '42307372'
            };
        }

        function clearOriginAirport() {
            const originInput = document.getElementById('origin_airport');
            originInput.value = '';
            originInput.focus();
        }

        document.getElementById('flightSearchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const searchBtn = document.getElementById('searchBtn');
            const loading = document.getElementById('loading');
            const resultsSection = document.getElementById('resultsSection');
            const errorMessage = document.getElementById('errorMessage');

            errorMessage.classList.add('hidden');
            resultsSection.classList.add('hidden');
            loading.classList.remove('hidden');
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';

            try {
                currentFlightData = {
                    airline: 'AV',
                    flight_number: formData.get('flight_number'),
                    departure_date: formData.get('departure_date') + 'T00:00:00Z',
                    origin_airport: formData.get('origin_airport').toUpperCase(),
                    operational_number: '42307372'
                };

                const response = await fetch('/api/flight_details', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentFlightData)
                });

                const result = await response.json();

                if (result.success) {
                    displayFlightDetails(result.flight_details);
                    resultsSection.classList.remove('hidden');
                    
                    setTimeout(() => {
                        document.getElementById('flightNumberTop').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 100);
                    
                    // Automatically load previous flight if available
                    if (result.flight_details.PreviousFlight) {
                        setTimeout(() => {
                            loadPreviousFlight(result.flight_details.PreviousFlight);
                        }, 500);
                    }
                    
                    setTimeout(() => {
                        loadCrewMembers();
                    }, 500);
                } else {
                    showError(result.error || 'Failed to fetch flight details');
                }

            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                loading.classList.add('hidden');
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search Flight';
            }
        });

        async function loadCrewMembers() {
            if (!currentFlightData) {
                console.error('No currentFlightData available for crew loading');
                return;
            }

            try {
                const response = await fetch('/api/flight_crew', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentFlightData)
                });

                const result = await response.json();
                if (result.success) {
                    displayCrewMembers(result.crew_data);
                } else {
                    console.error('Failed to load crew members:', result.error);
                }
            } catch (error) {
                console.error('Error loading crew members:', error);
            }
        }

        async function loadPreviousFlight(previousFlightData) {
            if (!previousFlightData) return;

            const previousFlightSection = document.getElementById('previousFlightSection');
            const title = document.querySelector('.content-section-title[onclick]');
            
            // Show loading state
            title.classList.add('loading');
            title.textContent = 'Previous Flight - Loading...';

            try {
                // Extract flight number from previous flight data - USING LOCAL DATE
                const flightNumber = previousFlightData.Prv_commercialFlightNumber;
                const airline = previousFlightData.Prv_airline || 'AV';
                // Use LOCAL date instead of UTC date
                const departureDateLocal = previousFlightData.Prv_departureDateLOCAL;
                const dateString = departureDateLocal.split('T')[0]; // Extract date part from local datetime
                const originAirport = previousFlightData.Prv_departureAirportIATACode;

                const searchData = {
                    airline: airline,
                    flight_number: flightNumber,
                    departure_date: dateString + 'T00:00:00Z',
                    origin_airport: originAirport,
                    operational_number: '42307372'
                };

                const response = await fetch('/api/flight_details', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(searchData)
                });

                const result = await response.json();

                if (result.success) {
                    displayPreviousFlightDetails(result.flight_details);
                    title.textContent = 'Previous Flight';
                } else {
                    console.error('Failed to load previous flight:', result.error);
                    title.textContent = 'Previous Flight - Click to retry';
                }

            } catch (error) {
                console.error('Network error loading previous flight:', error);
                title.textContent = 'Previous Flight - Click to retry';
            } finally {
                title.classList.remove('loading');
            }
        }

        function displayFlightDetails(flight) {
            const container = document.getElementById('flightDetails');
            
            let statusClass = 'status-scheduled';
            let statusText = flight.FlightStatus || 'Unknown';
            if (flight.FlightStatusCode === 'ARR') {
                statusClass = 'status-arrived';
            } else if (flight.TimeDelayed) {
                statusClass = 'status-delayed';
            }

            // Extract time from local time strings instead of UTC
            function formatTime(dateString) {
                if (!dateString) return 'N/A';
                // Extract HH:MM directly from the local time string
                return dateString.slice(11, 16);
            }

            function formatDuration(minutes) {
                if (!minutes) return '';
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `(${hours}h ${mins}m)`;
            }

            const html = `
                <div class="flight-details">
                    <div class="flight-header">
                        <div class="flight-number-line">
                            <div class="flight-number-large" id="flightNumberTop">
                                ${flight.Flight?.Airline || 'AV'}${flight.Flight?.CommercialFlightNumber || 'N/A'}
                            </div>
                            <div class="tail-number">${flight.AircraftRegistrationNumber || 'N/A'}</div>
                        </div>
                        
                        <div class="route-line">
                            ${flight.Flight?.OriginAirportIATACode || 'N/A'} → ${flight.Flight?.FinalAirportIATACode || 'N/A'}
                        </div>
                        
                        <div class="time-comparison">
                            <div class="time-line">
                                <span class="time-label">Scheduled:</span>
                                <span class="time-value">${formatTime(flight.Flight?.ScheduleDepartureDateLOCAL)} - ${formatTime(flight.Flight?.ScheduleArrivalDateLOCAL)}</span>
                                <span class="duration">${formatDuration(flight.Flight?.ScheduledDuration)}</span>
                            </div>
                            <div class="time-line">
                                <span class="time-label">Actual:</span>
                                <span class="time-value">${formatTime(flight.Flight?.DepartureDateLOCAL)} - ${formatTime(flight.Flight?.ArrivalDateLOCAL)}</span>
                                <span class="duration">${formatDuration(flight.Flight?.Duration)}</span>
                            </div>
                        </div>
                        
                        <div class="flight-status ${statusClass}">${statusText}</div>
                    </div>

                    ${flight.PreviousFlight ? `
                    <div class="content-section-title" onclick="loadPreviousFlight(${JSON.stringify(flight.PreviousFlight).replace(/"/g, '&quot;')})">
                        Previous Flight
                    </div>
                    <div id="previousFlightSection">
                        <div class="loading">Loading previous flight...</div>
                    </div>
                    ` : '<div class="content-section-title">Previous Flight</div><div class="detail-item"><span class="detail-value">No previous flight data available</span></div>'}

                    <div id="crewSection"></div>

                    <div class="content-section-title">Flight Details</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Operational Number:</span>
                            <span class="detail-value">${flight.Flight?.OperationalNumber || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Service Type:</span>
                            <span class="detail-value">${flight.Flight?.Service_type || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Fleet Type:</span>
                            <span class="detail-value">${flight.Fleet || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Departure Gate:</span>
                            <span class="detail-value">${flight.DepartureGate || 'N/A'} ${flight.DepartureTerminal ? `(T${flight.DepartureTerminal})` : ''}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Arrival Gate:</span>
                            <span class="detail-value">${flight.ArrivalGate || 'N/A'} ${flight.ArrivalTerminal ? `(T${flight.ArrivalTerminal})` : ''}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Time Advanced:</span>
                            <span class="detail-value">${flight.Flight?.TimeAdvanced ? 'Yes' : 'No'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Time Delayed:</span>
                            <span class="detail-value">${flight.Flight?.TimeDelayed ? 'Yes' : 'No'}</span>
                        </div>
                    </div>

                    ${flight.MELs && flight.MELs.length > 0 ? `
                    <div class="content-section-title">Equipment Issues (MELs)</div>
                    <ul class="mel-list">
                        ${flight.MELs.map(mel => `
                            <li class="mel-item">
                                <div class="mel-code">${mel.MELCode || 'N/A'}</div>
                                <div class="mel-desc">${mel.MELDesc || 'No description'}</div>
                                ${mel.MELComment ? `<div class="mel-desc">Comment: ${mel.MELComment}</div>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                    ` : ''}

                    <div class="success-message">
                        <strong>Last Updated:</strong> ${new Date(flight.LastModified).toLocaleString()}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function displayPreviousFlightDetails(flight) {
            const previousFlightSection = document.getElementById('previousFlightSection');
            
            // Extract time from local time strings instead of UTC
            function formatTime(dateString) {
                if (!dateString) return 'N/A';
                // Extract HH:MM directly from the local time string
                return dateString.slice(11, 16);
            }

            function formatDuration(minutes) {
                if (!minutes) return '';
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `(${hours}h ${mins}m)`;
            }

            const html = `
                <div class="flight-header">
                    <div class="flight-number-line">
                        <div class="previous-flight-number">
                            ${flight.Flight?.Airline || 'AV'}${flight.Flight?.CommercialFlightNumber || 'N/A'}
                        </div>
                        <!-- Removed tail number since it's the same aircraft -->
                    </div>
                    
                    <div class="route-line">
                        ${flight.Flight?.OriginAirportIATACode || 'N/A'} → ${flight.Flight?.FinalAirportIATACode || 'N/A'}
                    </div>
                    
                    <div class="time-comparison">
                        <div class="time-line">
                            <span class="time-label">Scheduled:</span>
                            <span class="time-value">${formatTime(flight.Flight?.ScheduleDepartureDateLOCAL)} - ${formatTime(flight.Flight?.ScheduleArrivalDateLOCAL)}</span>
                            <span class="duration">${formatDuration(flight.Flight?.ScheduledDuration)}</span>
                        </div>
                        <div class="time-line">
                            <span class="time-label">Actual:</span>
                            <span class="time-value">${formatTime(flight.Flight?.DepartureDateLOCAL)} - ${formatTime(flight.Flight?.ArrivalDateLOCAL)}</span>
                            <span class="duration">${formatDuration(flight.Flight?.Duration)}</span>
                        </div>
                    </div>
                </div>
            `;

            previousFlightSection.innerHTML = html;
        }

        function displayCrewMembers(crewData) {
            if (!crewData.MembersTeamFlight || crewData.MembersTeamFlight.length === 0) return;

            const crewSection = document.getElementById('crewSection');
            let html = `
                <div class="content-section-title">Crew Members</div>
                <div class="crew-list">
            `;

            crewData.MembersTeamFlight.forEach((member, index) => {
                const position = member.Position || 'Unknown';
                const profile = member.Profile || {};
                const fleet = profile.Qualifications ? profile.Qualifications.join(', ') : (profile.RawQualifications || 'N/A');
                
                let cardClass = 'crew-member-compact crew-card';
                if (position.includes('CP')) cardClass += ' captain';
                else if (position.includes('FO')) cardClass += ' first-officer';
                else if (position.includes('FA')) cardClass += ' fa';
                else if (position.includes('DH')) cardClass += ' dh';

                html += `
                    <div class="${cardClass}" onclick="toggleCrewDetails(${index})">
                        <div class="crew-name">${member.Names || ''} ${member.LastName || ''}</div>
                        <div class="crew-position">${position}</div>
                        <div class="crew-details-expanded" id="crew-details-${index}" style="display: none;">
                            <div class="crew-detail-item">
                                <span>Crew ID:</span>
                                <span>${member.CrewMemberUniqueId || 'N/A'}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Base:</span>
                                <span>${profile.Base || 'N/A'}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Fleet:</span>
                                <span>${fleet}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Seniority:</span>
                                <span>${profile.Superiority || 'N/A'}</span>
                            </div>
                            ${member.FlightRole ? `<div class="crew-role">${member.FlightRole}</div>` : ''}
                            ${profile.TelephoneNumber ? `
                            <div class="crew-detail-item">
                                <span>Phone:</span>
                                <span>${profile.TelephoneNumber}</span>
                            </div>
                            ` : ''}
                            ${profile.CorporateEmail ? `
                            <div class="crew-email">${profile.CorporateEmail}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            crewSection.innerHTML = html;
        }

        function toggleCrewDetails(index) {
            const crewMember = document.querySelectorAll('.crew-member-compact')[index];
            const details = document.getElementById(`crew-details-${index}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                crewMember.classList.add('expanded');
            } else {
                details.style.display = 'none';
                crewMember.classList.remove('expanded');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Prevent zooming with keyboard
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '=')) || 
                (e.ctrlKey && e.key === '0') ||
                (e.metaKey && (e.key === '+' || e.key === '-' || e.key === '=')) ||
                (e.metaKey && e.key === '0')) {
                e.preventDefault();
            }
        });

        // Prevent zooming with wheel
        document.addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>