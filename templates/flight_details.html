<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLIGHT SEARCH - Crew Schedule Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #121212;
            color: #f0f0f0;
            font-size: 0.7em;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
        }

        .header {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .nav-buttons {
            text-align: center;
            margin: 15px 0;
        }

        .nav-button {
            background: #3a3a3a;
            color: #f0f0f0;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            text-decoration: none;
            display: inline-block;
        }

        .nav-button:hover {
            background: #4a4a4a;
        }

        .nav-button.active {
            background: #f0f0f0;
            color: #121212;
        }

        .content-section {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #444;
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #f0f0f0;
            font-size: 0.9em;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #444;
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: #1e1e1e;
            color: #f0f0f0;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #555;
            background: #2a2a2a;
        }

        .clear-button {
            position: absolute;
            right: 8px;
            top: 28px;
            background: #555;
            color: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-button:hover {
            background: #666;
        }

        .btn {
            background: #555;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            grid-column: 1 / -1;
            margin-top: 8px;
        }

        .btn:hover {
            background: #666;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 15px;
            color: #ffc107;
            font-size: 0.9em;
        }

        .flight-details {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid #444;
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444;
        }

        .flight-number {
            font-size: 1.6em;
            font-weight: 600;
            color: #ffc107;
        }

        .flight-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8em;
        }

        .status-arrived {
            background: #2e7d32;
            color: white;
        }

        .status-scheduled {
            background: #1976d2;
            color: white;
        }

        .status-delayed {
            background: #d32f2f;
            color: white;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
        }

        .detail-card h3 {
            color: #f0f0f0;
            margin-bottom: 12px;
            font-size: 1em;
            border-bottom: 1px solid #444;
            padding-bottom: 6px;
            font-weight: 600;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #333;
        }

        .detail-label {
            font-weight: 600;
            color: #b8b8d0;
            font-size: 0.85em;
        }

        .detail-value {
            color: #f0f0f0;
            text-align: right;
            font-size: 0.85em;
        }

        .time-comparison {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .time-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            background: #1e1e1e;
            border: 1px solid #444;
        }

        .time-label {
            font-size: 0.8em;
            color: #b8b8d0;
            margin-bottom: 4px;
        }

        .time-value {
            font-weight: 600;
            color: #f0f0f0;
            font-size: 0.85em;
        }

        .time-advanced {
            color: #81c784;
        }

        .time-delayed {
            color: #e57373;
        }

        .mel-list {
            list-style: none;
        }

        .mel-item {
            background: #5a3a3a;
            border: 1px solid #7a3a3a;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .mel-code {
            font-weight: 600;
            color: #ffab91;
            font-size: 0.85em;
        }

        .mel-desc {
            color: #ffab91;
            font-size: 0.8em;
        }

        .error-message {
            background: #5a3a3a;
            color: #f8d7da;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #7a3a3a;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
        }

        .success-message {
            background: #2e4b2e;
            color: #d4edda;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #3a5a3a;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
        }

        .crew-info {
            background: #3a3a3a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #444;
            font-size: 0.85em;
        }

        .hidden {
            display: none;
        }

        /* Crew Members Styles - Compact with expandable details */
        .crew-section {
            margin-top: 20px;
        }

        .crew-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .crew-member-compact {
            background: #2a2a2a;
            border-radius: 6px;
            padding: 8px;
            border: 1px solid #444;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75em;
        }

        .crew-member-compact:hover {
            background: #333;
            border-color: #555;
        }

        .crew-member-compact.expanded {
            background: #3a3a3a;
            border-color: #666;
        }

        .crew-name {
            font-weight: 600;
            color: #f0f0f0;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .crew-position {
            color: #ffc107;
            font-size: 0.8em;
            font-weight: 600;
        }

        .crew-details-expanded {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #444;
            font-size: 0.7em;
            color: #b8b8d0;
        }

        .crew-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .crew-email {
            color: #90caf9;
            word-break: break-all;
            margin-top: 5px;
        }

        .crew-role {
            font-style: italic;
            color: #b8b8d0;
            margin-top: 3px;
        }

        .crew-card.captain .crew-position {
            color: #e57373;
        }

        .crew-card.first-officer .crew-position {
            color: #ffb74d;
        }

        .crew-card.fa .crew-position {
            color: #81c784;
        }

        .crew-card.dh .crew-position {
            color: #ba68c8;
        }

        @media (max-width: 768px) {
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .flight-header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .crew-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FLIGHT SEARCH</h1>
            <div class="crew-info">
                <strong>Current Crew ID:</strong> {{ current_crew_id }}
            </div>
        </div>

        <div class="nav-buttons">
            <a href="/" class="nav-button">Schedule View</a>
            <a href="/calendar" class="nav-button">Calendar View</a>
            <a href="/pdf" class="nav-button">PDF Download</a>
            <a href="/flight_details" class="nav-button active">Flight Search</a>
        </div>

        <div class="content-section">
            <!-- Simplified Flight Search -->
            <form id="flightSearchForm" class="search-form">
                <div class="form-group">
                    <label for="flight_number">Flight Number *</label>
                    <input type="text" id="flight_number" name="flight_number" required placeholder="e.g., 210">
                </div>

                <div class="form-group">
                    <label for="departure_date">Departure Date *</label>
                    <input type="date" id="departure_date" name="departure_date" required>
                </div>

                <div class="form-group">
                    <label for="origin_airport">Origin Airport (IATA) *</label>
                    <input type="text" id="origin_airport" name="origin_airport" required value="BOG" maxlength="3">
                    <button type="button" class="clear-button" onclick="clearOriginAirport()">×</button>
                </div>

                <button type="submit" class="btn" id="searchBtn">
                    Search Flight
                </button>
            </form>

            <!-- Loading Indicator -->
            <div id="loading" class="loading hidden">
                <div>Fetching flight details...</div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <div id="flightDetails"></div>
                
                <!-- Crew Members Section - Auto-loaded and compact -->
                <div id="crewSection" class="crew-section">
                    <div id="crewLoading" class="loading hidden">
                        <div>Loading crew information...</div>
                    </div>
                    
                    <div id="crewResults">
                        <div id="crewMembers" class="crew-list"></div>
                    </div>
                    
                    <div id="crewErrorMessage" class="error-message hidden"></div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message hidden"></div>
        </div>
    </div>

    <script>
        // Set default departure date to today
        document.getElementById('departure_date').value = new Date().toISOString().slice(0, 10);

        // Store current flight data globally
        let currentFlightData = null;

        // Clear origin airport function
        function clearOriginAirport() {
            const originInput = document.getElementById('origin_airport');
            originInput.value = '';
            originInput.focus();
        }

        // Form submission handler
        document.getElementById('flightSearchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const searchBtn = document.getElementById('searchBtn');
            const loading = document.getElementById('loading');
            const resultsSection = document.getElementById('resultsSection');
            const errorMessage = document.getElementById('errorMessage');
            const flightDetails = document.getElementById('flightDetails');
            const crewSection = document.getElementById('crewSection');
            const crewResults = document.getElementById('crewResults');
            const crewErrorMessage = document.getElementById('crewErrorMessage');

            // Reset UI
            errorMessage.classList.add('hidden');
            resultsSection.classList.add('hidden');
            crewResults.classList.add('hidden');
            crewErrorMessage.classList.add('hidden');
            loading.classList.remove('hidden');
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';

            try {
                currentFlightData = {
                    airline: 'AV', // Hardcoded
                    flight_number: formData.get('flight_number'),
                    departure_date: formData.get('departure_date') + 'T00:00:00Z', // Add time for API
                    origin_airport: formData.get('origin_airport').toUpperCase(),
                    operational_number: '42307372' // Hardcoded
                };

                const response = await fetch('/api/flight_details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentFlightData)
                });

                const result = await response.json();

                if (result.success) {
                    displayFlightDetails(result.flight_details);
                    resultsSection.classList.remove('hidden');
                    // Auto-load crew members
                    setTimeout(() => {
                        loadCrewMembers();
                    }, 500);
                } else {
                    showError(result.error || 'Failed to fetch flight details');
                }

            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                loading.classList.add('hidden');
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search Flight';
            }
        });

        // Crew Members functionality - Auto-called
        async function loadCrewMembers() {
            if (!currentFlightData) {
                showCrewError('No flight data available.');
                return;
            }

            const crewLoading = document.getElementById('crewLoading');
            const crewResults = document.getElementById('crewResults');
            const crewErrorMessage = document.getElementById('crewErrorMessage');
            const crewMembers = document.getElementById('crewMembers');

            // Reset UI
            crewErrorMessage.classList.add('hidden');
            crewResults.classList.add('hidden');
            crewLoading.classList.remove('hidden');

            try {
                const response = await fetch('/api/flight_crew', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentFlightData)
                });

                const result = await response.json();

                if (result.success) {
                    displayCrewMembers(result.crew_data);
                    crewResults.classList.remove('hidden');
                } else {
                    showCrewError(result.error || 'Failed to fetch crew data');
                }

            } catch (error) {
                showCrewError('Network error: ' + error.message);
            } finally {
                crewLoading.classList.add('hidden');
            }
        }

        function displayFlightDetails(flight) {
            const container = document.getElementById('flightDetails');
            
            // Determine status class
            let statusClass = 'status-scheduled';
            let statusText = flight.FlightStatus || 'Unknown';
            if (flight.FlightStatusCode === 'ARR') {
                statusClass = 'status-arrived';
            } else if (flight.TimeDelayed) {
                statusClass = 'status-delayed';
            }

            // Format dates
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleString();
            }

            // Format duration
            function formatDuration(minutes) {
                if (!minutes) return 'N/A';
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}h ${mins}m`;
            }

            const html = `
                <div class="flight-details">
                    <div class="flight-header">
                        <div class="flight-number">${flight.Flight?.Airline || 'AV'}${flight.Flight?.CommercialFlightNumber || 'N/A'}</div>
                        <div class="flight-status ${statusClass}">${statusText}</div>
                    </div>

                    <div class="details-grid">
                        <!-- Route Information -->
                        <div class="detail-card">
                            <h3>Route Information</h3>
                            <div class="detail-item">
                                <span class="detail-label">Origin:</span>
                                <span class="detail-value">${flight.Flight?.OriginAirportIATACode || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Destination:</span>
                                <span class="detail-value">${flight.Flight?.FinalAirportIATACode || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Operational Number:</span>
                                <span class="detail-value">${flight.Flight?.OperationalNumber || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Service Type:</span>
                                <span class="detail-value">${flight.Flight?.Service_type || 'N/A'}</span>
                            </div>
                        </div>

                        <!-- Aircraft Information -->
                        <div class="detail-card">
                            <h3>Aircraft Information</h3>
                            <div class="detail-item">
                                <span class="detail-label">Registration:</span>
                                <span class="detail-value">${flight.AircraftRegistrationNumber || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Fleet Type:</span>
                                <span class="detail-value">${flight.Fleet || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Departure Gate:</span>
                                <span class="detail-value">${flight.DepartureGate || 'N/A'} ${flight.DepartureTerminal ? `(T${flight.DepartureTerminal})` : ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Arrival Gate:</span>
                                <span class="detail-value">${flight.ArrivalGate || 'N/A'} ${flight.ArrivalTerminal ? `(T${flight.ArrivalTerminal})` : ''}</span>
                            </div>
                        </div>

                        <!-- Schedule Information -->
                        <div class="detail-card">
                            <h3>Schedule Times</h3>
                            <div class="detail-item">
                                <span class="detail-label">Scheduled Departure (UTC):</span>
                                <span class="detail-value">${formatDate(flight.Flight?.ScheduleDepartureDateUTC)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Actual Departure (UTC):</span>
                                <span class="detail-value">${formatDate(flight.Flight?.DepartureDateUTC)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Scheduled Arrival (UTC):</span>
                                <span class="detail-value">${formatDate(flight.Flight?.ScheduleArrivalDateUTC)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Actual Arrival (UTC):</span>
                                <span class="detail-value">${formatDate(flight.Flight?.ArrivalDateUTC)}</span>
                            </div>
                        </div>

                        <!-- Flight Performance -->
                        <div class="detail-card">
                            <h3>Flight Performance</h3>
                            <div class="detail-item">
                                <span class="detail-label">Actual Duration:</span>
                                <span class="detail-value">${formatDuration(flight.Flight?.Duration)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Scheduled Duration:</span>
                                <span class="detail-value">${formatDuration(flight.Flight?.ScheduledDuration)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Time Advanced:</span>
                                <span class="detail-value ${flight.Flight?.TimeAdvanced ? 'time-advanced' : ''}">
                                    ${flight.Flight?.TimeAdvanced ? 'Yes' : 'No'}
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Time Delayed:</span>
                                <span class="detail-value ${flight.Flight?.TimeDelayed ? 'time-delayed' : ''}">
                                    ${flight.Flight?.TimeDelayed ? 'Yes' : 'No'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- MELs (Minimum Equipment List) -->
                    ${flight.MELs && flight.MELs.length > 0 ? `
                    <div class="detail-card">
                        <h3>Equipment Issues (MELs)</h3>
                        <ul class="mel-list">
                            ${flight.MELs.map(mel => `
                                <li class="mel-item">
                                    <div class="mel-code">${mel.MELCode || 'N/A'}</div>
                                    <div class="mel-desc">${mel.MELDesc || 'No description'}</div>
                                    ${mel.MELComment ? `<div class="mel-desc">Comment: ${mel.MELComment}</div>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    <!-- Previous Flight -->
                    ${flight.PreviousFlight ? `
                    <div class="detail-card">
                        <h3>Previous Flight</h3>
                        <div class="detail-item">
                            <span class="detail-label">Flight:</span>
                            <span class="detail-value">${flight.PreviousFlight.Prv_airline || ''}${flight.PreviousFlight.Prv_commercialFlightNumber || ''}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Route:</span>
                            <span class="detail-value">${flight.PreviousFlight.Prv_departureAirportIATACode || 'N/A'} → ${flight.PreviousFlight.Prv_arrivalAirportIATACode || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Departure:</span>
                            <span class="detail-value">${formatDate(flight.PreviousFlight.Prv_departureDateUTC)}</span>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Last Updated -->
                    <div class="success-message">
                        <strong>Last Updated:</strong> ${formatDate(flight.LastModified)}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function displayCrewMembers(crewData) {
            const container = document.getElementById('crewMembers');
            
            if (!crewData.MembersTeamFlight || crewData.MembersTeamFlight.length === 0) {
                container.innerHTML = '<div class="error-message">No crew members found for this flight.</div>';
                return;
            }

            const crewMembers = crewData.MembersTeamFlight;
            
            const html = crewMembers.map((member, index) => {
                const position = member.Position || 'Unknown';
                const profile = member.Profile || {};
                
                // Determine card class based on position
                let cardClass = 'crew-member-compact crew-card';
                if (position.includes('CP')) cardClass += ' captain';
                else if (position.includes('FO')) cardClass += ' first-officer';
                else if (position.includes('FA')) cardClass += ' fa';
                else if (position.includes('DH')) cardClass += ' dh';
                
                // Format fleet/qualifications
                const fleet = profile.Qualifications ? profile.Qualifications.join(', ') : (profile.RawQualifications || 'N/A');
                
                return `
                    <div class="${cardClass}" onclick="toggleCrewDetails(${index})">
                        <div class="crew-name">${member.Names || ''} ${member.LastName || ''}</div>
                        <div class="crew-position">${position}</div>
                        <div class="crew-details-expanded" id="crew-details-${index}" style="display: none;">
                            <div class="crew-detail-item">
                                <span>Crew ID:</span>
                                <span>${member.CrewMemberUniqueId || 'N/A'}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Base:</span>
                                <span>${profile.Base || 'N/A'}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Fleet:</span>
                                <span>${fleet}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Seniority:</span>
                                <span>${profile.Superiority || 'N/A'}</span>
                            </div>
                            ${member.FlightRole ? `<div class="crew-role">${member.FlightRole}</div>` : ''}
                            ${profile.TelephoneNumber ? `
                            <div class="crew-detail-item">
                                <span>Phone:</span>
                                <span>${profile.TelephoneNumber}</span>
                            </div>
                            ` : ''}
                            ${profile.CorporateEmail ? `
                            <div class="crew-email">${profile.CorporateEmail}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            
            // Also show messenger permissions if available
            if (crewData.MessengerPermissions !== undefined) {
                const messengerInfo = document.createElement('div');
                messengerInfo.className = 'success-message';
                messengerInfo.style.marginTop = '12px';
                messengerInfo.innerHTML = `<strong>Messenger Permissions:</strong> ${crewData.MessengerPermissions ? 'Enabled' : 'Disabled'}`;
                container.parentNode.insertBefore(messengerInfo, container);
            }
        }

        // Toggle crew member details
        function toggleCrewDetails(index) {
            const crewMember = document.querySelectorAll('.crew-member-compact')[index];
            const details = document.getElementById(`crew-details-${index}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                crewMember.classList.add('expanded');
            } else {
                details.style.display = 'none';
                crewMember.classList.remove('expanded');
            }
        }

        function showCrewError(message) {
            const errorDiv = document.getElementById('crewErrorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>