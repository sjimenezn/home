<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLIGHT SEARCH</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; margin: 10px; background: #121212; color: #f0f0f0; font-size: 16px; }
        .container { 
            max-width: 600px;
            margin: 10px auto;
            background: #2a2a2a; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #444; 
        }
        .header { text-align: center; margin-bottom: 15px; }
        .nav-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1px; background: #444; border-radius: 8px; overflow: hidden; margin: 10px 0; }
        .nav-button { padding: 12px 5px; background: #3a3a3a; color: #f0f0f0; text-decoration: none; text-align: center; }
        .nav-button.active { background: #f0f0f0; color: #121212; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .input-row { display: flex; gap: 10px; align-items: flex-end; }
        .short-input { width: 80px; text-align: center; padding: 12px; font-size: 16px; background: #1e1e1e; border: 1px solid #555; border-radius: 5px; color: #fff; }
        .date-input { flex: 1; padding: 12px; font-size: 16px; background: #1e1e1e; border: 1px solid #555; border-radius: 5px; color: #fff; }
        .button { padding: 12px; border: none; border-radius: 5px; font-size: 16px; height: 45px; }
        .clear-btn { background: #4a4a4a; color: #f0f0f0; width: 70px; flex-shrink: 0; }
        .search-btn { background: #555; color: #fff; flex: 1; }
        .loading, .error-message, .success-message { text-align: center; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .loading { color: #ffc107; }
        .error-message { background: #5a3a3a; color: #f8d7da; }
        .success-message { background: #2e4b2e; color: #d4edda; }
        .hidden { display: none; }
        
        .flight-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        .flight-number-line { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }
        .flight-info { flex: 1; }
        .flight-number { font-size: 1.8em; font-weight: bold; color: #ffc107; margin-bottom: 5px; }
        .flight-details { font-size: 0.9em; color: #b8b8d0; }
        .flight-status-center { 
            text-align: center; 
            flex: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .flight-status { 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.8em; 
            display: inline-block; 
            margin-top: 5px; 
        }
        .status-arrived { background: #2e7d32; }
        .status-scheduled { background: #1976d2; }
        .status-delayed { background: #d32f2f; }
        .tail-info { text-align: right; flex: 1; }
        .tail-number { font-size: 1.8em; color: #4fc3f7; font-weight: bold; margin-bottom: 5px; }
        .fleet-type { font-size: 1.1em; color: #ffffff; font-weight: bold; }
        .gate-info { font-size: 1.1em; color: #ffffff; font-weight: bold; margin-bottom: 5px; }
        .route-line { font-size: 1.2em; font-weight: bold; text-align: center; margin: 10px 0; }
        .time-comparison { text-align: center; margin: 10px 0; }
        .time-line { display: flex; justify-content: center; margin-bottom: 3px; font-size: 0.9em; }
        .time-label { width: 80px; color: #b8b8d0; text-align: right; margin-right: 10px; }
        .time-value { text-align: left; width: 120px; }
        .time-early { color: #81c784; }
        .time-late { color: #f44336; }
        
        /* Delay Info Styling */
        .delay-section { margin: 0; }
        .delay-title { 
            color: #ffffff; 
            margin: 10px 0 5px 0; 
            font-size: 0.8em; 
            border-bottom: 1px solid #444; 
            padding-bottom: 4px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .delay-title:hover { color: #ffc107; }
        .delay-details { 
            margin-top: 8px; 
            padding-top: 8px; 
            border-top: 1px solid #444; 
            font-size: 0.8em; 
            color: #b8b8d0; 
            display: none; 
        }
        .delay-detail-item { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 2px; 
        }
        .delay-group {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .delay-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .previous-flight-section { margin: 0; }
        .section-title { color: #f0f0f0; margin: 15px 0 8px 0; font-size: 0.9em; border-bottom: 1px solid #444; padding-bottom: 4px; font-weight: 600; cursor: pointer; }
        .section-title:hover { color: #ffc107; }
        .previous-flight-number { color: #b0b0b0 !important; font-size: 1.6em; }
        
        .crew-list { display: grid; grid-template-columns: 1fr; gap: 5px; margin: 10px 0; }
        .crew-member { background: #2a2a2a; padding: 8px; border-radius: 4px; border: 1px solid #444; cursor: pointer; }
        .crew-member.expanded { background: #3a3a3a; }
        .crew-name { font-weight: 600; font-size: 0.64em; }
        .crew-position { color: #ffc107; font-size: 0.576em; }
        .crew-details { margin-top: 8px; padding-top: 8px; border-top: 1px solid #444; font-size: 0.512em; color: #b8b8d0; display: none; }
        .crew-detail-item { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .crew-email { color: #90caf9; word-break: break-all; margin-top: 4px; font-size: 0.448em; }
        
        .mel-list { list-style: none; margin: 10px 0; }
        .mel-item { background: #5a3a3a; border: 1px solid #7a3a3a; border-radius: 3px; padding: 8px; margin-bottom: 6px; }
        .mel-code { font-weight: 600; color: #ffab91; font-size: 0.8em; }
        .mel-desc { color: #ffab91; font-size: 0.75em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FLIGHT SEARCH</h1>
            <div style="background: #3a3a3a; padding: 8px; border-radius: 4px; margin: 10px 0;">
                <strong>Crew ID:</strong> {{ current_crew_id }}
            </div>
        </div>

        <div class="nav-buttons">
            <a href="/" class="nav-button">üìã</a>
            <a href="/calendar" class="nav-button">üìÖ</a>
            <a href="/pdf" class="nav-button">üìÑ</a>
            <a href="/flight_details" class="nav-button active">üîç</a>
        </div>

        <div>
            <form id="flightSearchForm">
                <div class="input-group">
                    <label>Flight Number *</label>
                    <div class="input-row">
                        <input type="text" id="flight_number" class="short-input" required placeholder="210" maxlength="4">
                        <button type="button" class="button clear-btn" onclick="clearFlightNumber()">Clear</button>
                        <input type="date" id="departure_date" class="date-input" required>
                    </div>
                </div>

                <div class="input-group">
                    <label>Origin *</label>
                    <div class="input-row">
                        <input type="text" id="origin_airport" class="short-input" required value="BOG" maxlength="3">
                        <button type="button" class="button clear-btn" onclick="clearOriginAirport()">Clear</button>
                        <button type="submit" class="button search-btn" id="searchBtn">Search</button>
                    </div>
                </div>
            </form>

            <div id="loading" class="loading hidden">Loading...</div>
            <div id="resultsSection" class="hidden">
                <div id="flightDetails"></div>
            </div>
            <div id="errorMessage" class="error-message hidden"></div>
        </div>
    </div>

    <script>
        document.getElementById('departure_date').value = new Date().toISOString().slice(0, 10);
        let currentFlightData = null;

        const urlParams = new URLSearchParams(window.location.search);
        const flightNumber = urlParams.get('flight_number');
        const localDate = urlParams.get('local_date');
        const originAirport = urlParams.get('origin_airport');
        
        // Auto-search immediately if URL parameters are present
        if (flightNumber && localDate && originAirport) {
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('flight_number').value = flightNumber;
                document.getElementById('departure_date').value = localDate;
                document.getElementById('origin_airport').value = originAirport;
                // Remove delay - search immediately
                document.getElementById('flightSearchForm').dispatchEvent(new Event('submit'));
            });
        }

        function clearFlightNumber() {
            const flightInput = document.getElementById('flight_number');
            flightInput.value = '';
            flightInput.focus();
        }

        function clearOriginAirport() {
            const originInput = document.getElementById('origin_airport');
            originInput.value = '';
            originInput.focus();
        }

        document.getElementById('flightSearchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const searchBtn = document.getElementById('searchBtn');
            const loading = document.getElementById('loading');
            const resultsSection = document.getElementById('resultsSection');
            const errorMessage = document.getElementById('errorMessage');

            errorMessage.classList.add('hidden');
            resultsSection.classList.add('hidden');
            loading.classList.remove('hidden');
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';

            try {
                currentFlightData = {
                    airline: 'AV',
                    flight_number: document.getElementById('flight_number').value,
                    departure_date: document.getElementById('departure_date').value + 'T00:00:00Z',
                    origin_airport: document.getElementById('origin_airport').value.toUpperCase(),
                    operational_number: '42307372'
                };

                const response = await fetch('/api/flight_details', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentFlightData)
                });

                const result = await response.json();

                if (result.success) {
                    displayFlightDetails(result.flight_details);
                    resultsSection.classList.remove('hidden');
                    
                    // Load crew and previous flight in parallel for better performance
                    const loadPromises = [];
                    
                    if (result.flight_details.PreviousFlight) {
                        loadPromises.push(loadPreviousFlight(result.flight_details.PreviousFlight));
                    }
                    
                    loadPromises.push(loadCrewMembers());
                    
                    // Wait for all parallel loads to complete
                    Promise.all(loadPromises).finally(() => {
                        // Simple, reliable autoscroll with consistent timing
                        setTimeout(() => {
                            const flightNumberTop = document.getElementById('flightNumberTop');
                            if (flightNumberTop) {
                                flightNumberTop.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'start',
                                    inline: 'nearest'
                                });
                            }
                        }, 300); // Consistent 300ms delay for all cases
                    });
                    
                } else {
                    showError(result.error || 'Failed to fetch flight details');
                }

            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                loading.classList.add('hidden');
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        });

        async function loadCrewMembers() {
            if (!currentFlightData) return;
            try {
                const response = await fetch('/api/flight_crew', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentFlightData)
                });
                const result = await response.json();
                if (result.success) displayCrewMembers(result.crew_data);
            } catch (error) {}
        }

        async function loadPreviousFlight(previousFlightData) {
            if (!previousFlightData) return;

            const previousFlightSection = document.getElementById('previousFlightSection');
            const title = document.querySelector('.section-title[onclick]');
            
            if (!previousFlightSection || !title) return;

            title.classList.add('loading');
            title.textContent = 'Previous Flight - Loading...';

            try {
                const flightNumber = previousFlightData.Prv_commercialFlightNumber || previousFlightData.CommercialFlightNumber;
                const airline = previousFlightData.Prv_airline || previousFlightData.Airline || 'AV';
                const departureDateLocal = previousFlightData.Prv_departureDateLOCAL || previousFlightData.DepartureDateLOCAL;
                const originAirport = previousFlightData.Prv_departureAirportIATACode || previousFlightData.OriginAirportIATACode;
                
                if (!flightNumber || !departureDateLocal || !originAirport) {
                    throw new Error('Missing previous flight data');
                }

                const dateString = departureDateLocal.split('T')[0];
                const searchData = {
                    airline: airline,
                    flight_number: flightNumber,
                    departure_date: dateString + 'T00:00:00Z',
                    origin_airport: originAirport,
                    operational_number: '42307372'
                };

                const response = await fetch('/api/flight_details', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(searchData)
                });

                const result = await response.json();

                if (result.success) {
                    displayPreviousFlightDetails(result.flight_details);
                    title.textContent = 'Previous Flight';
                } else {
                    throw new Error(result.error || 'Failed to load previous flight');
                }

            } catch (error) {
                title.textContent = 'Previous Flight - Click to retry';
                previousFlightSection.innerHTML = `<div class="error-message">Failed to load previous flight</div>`;
            } finally {
                title.classList.remove('loading');
            }
        }

        function displayFlightDetails(flight) {
            const container = document.getElementById('flightDetails');
            const statusClass = flight.FlightStatusCode === 'ARR' ? 'status-arrived' : 
                              flight.TimeDelayed ? 'status-delayed' : 'status-scheduled';
            
            // Get gate and terminal information
            const departureStand = flight.DepartureParkingStand || '';
            const departureTerminal = flight.DepartureTerminal || '';
            
            // Format gate info as "GATE: xx T: xx"
            let gateInfo = '';
            if (departureStand && departureTerminal) {
                gateInfo = `GATE: ${departureStand} T: ${departureTerminal}`;
            } else if (departureStand) {
                gateInfo = `GATE: ${departureStand}`;
            } else if (departureTerminal) {
                gateInfo = `T: ${departureTerminal}`;
            }
            
            const fleet = flight.Fleet || '';
            
            // Calculate time colors
            const scheduledDeparture = flight.Flight?.ScheduleDepartureDateLOCAL;
            const actualDeparture = flight.Flight?.DepartureDateLOCAL;
            const scheduledArrival = flight.Flight?.ScheduleArrivalDateLOCAL;
            const actualArrival = flight.Flight?.ArrivalDateLOCAL;
            
            const departureColor = getTimeColor(actualDeparture, scheduledDeparture);
            const arrivalColor = getTimeColor(actualArrival, scheduledArrival);
            
            // Create the actual time string with colored spans
            const actualTimeString = `<span class="${departureColor}">${formatTime(actualDeparture)}</span> - <span class="${arrivalColor}">${formatTime(actualArrival)}</span>`;
            
            // Check if delay info exists - Delays is an array!
            const hasDelayInfo = flight.Delays && flight.Delays.length > 0;
            
            const html = `
                <div class="flight-header">
                    <div class="flight-number-line">
                        <div class="flight-info">
                            <div class="flight-number" id="flightNumberTop">
                                ${flight.Flight?.Airline || 'AV'}${flight.Flight?.CommercialFlightNumber || 'N/A'}
                            </div>
                            <div class="flight-details">${gateInfo ? `<div class="gate-info">${gateInfo}</div>` : ''}</div>
                        </div>
                        <div class="flight-status-center">
                            <div class="flight-status ${statusClass}">${flight.FlightStatus || 'Unknown'}</div>
                        </div>
                        <div class="tail-info">
                            <div class="tail-number">${flight.AircraftRegistrationNumber || 'N/A'}</div>
                            <div class="fleet-type">${fleet}</div>
                        </div>
                    </div>
                    
                    <div class="route-line">
                        ${flight.Flight?.OriginAirportIATACode || 'N/A'} ‚Üí ${flight.Flight?.FinalAirportIATACode || 'N/A'}
                    </div>
                    
                    <div class="time-comparison">
                        <div class="time-line">
                            <span class="time-label">Scheduled:</span>
                            <span class="time-value">${formatTime(scheduledDeparture)} - ${formatTime(scheduledArrival)}</span>
                        </div>
                        <div class="time-line">
                            <span class="time-label">Actual:</span>
                            <span class="time-value">${actualTimeString}</span>
                        </div>
                    </div>

                    ${hasDelayInfo ? `
                    <div class="delay-section">
                        <div class="delay-title" onclick="toggleDelayDetails()">
                            DELAY INFO ${flight.Delays.length > 1 ? `(${flight.Delays.length})` : ''}
                        </div>
                        <div class="delay-details" id="delayDetails">
                            ${flight.Delays.map((delay, index) => `
                                <div class="delay-group">
                                    ${delay.DelayCode ? `
                                    <div class="delay-detail-item">
                                        <span>Delay Code:</span>
                                        <span>${delay.DelayCode}</span>
                                    </div>
                                    ` : ''}
                                    ${delay.DelayDesc ? `
                                    <div class="delay-detail-item">
                                        <span>Delay Description:</span>
                                        <span>${delay.DelayDesc}</span>
                                    </div>
                                    ` : ''}
                                    ${delay.DelayTime ? `
                                    <div class="delay-detail-item">
                                        <span>Delay Time:</span>
                                        <span>${delay.DelayTime} minutes</span>
                                    </div>
                                    ` : ''}
                                </div>
                                ${flight.Delays.length > 1 && index < flight.Delays.length - 1 ? '<hr style="border: none; border-top: 1px solid #333; margin: 8px 0;">' : ''}
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>

                ${flight.PreviousFlight ? `
                <div class="previous-flight-section">
                    <div class="section-title" onclick="loadPreviousFlight(${JSON.stringify(flight.PreviousFlight).replace(/"/g, '&quot;')})">
                        Previous Flight
                    </div>
                    <div id="previousFlightSection">
                        <div class="loading">Loading previous flight...</div>
                    </div>
                </div>
                ` : '<div class="section-title">Previous Flight</div><div style="color: #b8b8d0; font-size: 0.9em; margin: 10px 0;">No previous flight data</div>'}

                <div id="crewSection"></div>

                ${flight.MELs && flight.MELs.length > 0 ? `
                <div class="section-title">Equipment Issues (MELs)</div>
                <ul class="mel-list">
                    ${flight.MELs.map(mel => `
                        <li class="mel-item">
                            <div class="mel-code">${mel.MELCode || 'N/A'}</div>
                            <div class="mel-desc">${mel.MELDesc || 'No description'}</div>
                            ${mel.MELComment ? `<div class="mel-desc">Comment: ${mel.MELComment}</div>` : ''}
                        </li>
                    `).join('')}
                </ul>
                ` : ''}

                <div class="success-message">
                    <strong>Last Updated:</strong> ${new Date(flight.LastModified).toLocaleString()}
                </div>
            `;

            container.innerHTML = html;
        }

        function displayPreviousFlightDetails(flight) {
            const previousFlightSection = document.getElementById('previousFlightSection');
            
            // Calculate time colors for previous flight
            const scheduledDeparture = flight.Flight?.ScheduleDepartureDateLOCAL;
            const actualDeparture = flight.Flight?.DepartureDateLOCAL;
            const scheduledArrival = flight.Flight?.ScheduleArrivalDateLOCAL;
            const actualArrival = flight.Flight?.ArrivalDateLOCAL;
            
            const departureColor = getTimeColor(actualDeparture, scheduledDeparture);
            const arrivalColor = getTimeColor(actualArrival, scheduledArrival);
            
            // Create the actual time string with colored spans
            const actualTimeString = `<span class="${departureColor}">${formatTime(actualDeparture)}</span> - <span class="${arrivalColor}">${formatTime(actualArrival)}</span>`;
            
            const html = `
                <div class="flight-header">
                    <div class="route-line">
                        ${flight.Flight?.Airline || 'AV'}${flight.Flight?.CommercialFlightNumber || 'N/A'} ${flight.Flight?.OriginAirportIATACode || 'N/A'} ‚Üí ${flight.Flight?.FinalAirportIATACode || 'N/A'}
                    </div>
                    
                    <div class="time-comparison">
                        <div class="time-line">
                            <span class="time-label">Scheduled:</span>
                            <span class="time-value">${formatTime(scheduledDeparture)} - ${formatTime(scheduledArrival)}</span>
                        </div>
                        <div class="time-line">
                            <span class="time-label">Actual:</span>
                            <span class="time-value">${actualTimeString}</span>
                        </div>
                    </div>
                </div>
            `;

            previousFlightSection.innerHTML = html;
        }

        function toggleDelayDetails() {
            const details = document.getElementById('delayDetails');
            if (details.style.display === 'none') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        }

        function getTimeColor(actualTime, scheduledTime) {
            if (!actualTime || !scheduledTime) return '';
            
            const actual = actualTime.slice(11, 16);
            const scheduled = scheduledTime.slice(11, 16);
            
            const actualMinutes = parseInt(actual.split(':')[0]) * 60 + parseInt(actual.split(':')[1]);
            const scheduledMinutes = parseInt(scheduled.split(':')[0]) * 60 + parseInt(scheduled.split(':')[1]);
            
            return actualMinutes <= scheduledMinutes ? 'time-early' : 'time-late';
        }

        function formatTime(dateString) {
            return dateString ? dateString.slice(11, 16) : 'N/A';
        }

        function displayCrewMembers(crewData) {
            if (!crewData.MembersTeamFlight || crewData.MembersTeamFlight.length === 0) return;
            const crewSection = document.getElementById('crewSection');
            
            let html = `<div class="section-title">Crew Members</div><div class="crew-list">`;
            crewData.MembersTeamFlight.forEach((member, index) => {
                const profile = member.Profile || {};
                const fleet = profile.Qualifications ? profile.Qualifications.join(', ') : (profile.RawQualifications || 'N/A');
                
                html += `
                    <div class="crew-member" onclick="toggleCrewDetails(${index})">
                        <div class="crew-name">${member.Names || ''} ${member.LastName || ''}</div>
                        <div class="crew-position">${member.Position || 'Unknown'}</div>
                        <div class="crew-details" id="crew-details-${index}">
                            <div class="crew-detail-item">
                                <span>Crew ID:</span>
                                <span>${member.CrewMemberUniqueId || 'N/A'}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Base:</span>
                                <span>${profile.Base || 'N/A'}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Fleet:</span>
                                <span>${fleet}</span>
                            </div>
                            <div class="crew-detail-item">
                                <span>Seniority:</span>
                                <span>${profile.Superiority || 'N/A'}</span>
                            </div>
                            ${profile.TelephoneNumber ? `
                            <div class="crew-detail-item">
                                <span>Phone:</span>
                                <span>${profile.TelephoneNumber}</span>
                            </div>
                            ` : ''}
                            ${profile.CorporateEmail ? `
                            <div class="crew-email">${profile.CorporateEmail}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            crewSection.innerHTML = html;
        }

        function toggleCrewDetails(index) {
            const crewMember = document.querySelectorAll('.crew-member')[index];
            const details = document.getElementById(`crew-details-${index}`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                crewMember.classList.add('expanded');
            } else {
                details.style.display = 'none';
                crewMember.classList.remove('expanded');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>