<!DOCTYPE html>
<html>
<head>
    <title>My Crew Schedule</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .header { text-align: center; margin-bottom: 20px; }
        .nav-buttons { text-align: center; margin: 15px 0; }
        .nav-button { background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 0 5px; text-decoration: none; display: inline-block; }
        .nav-button:hover { background: #5a6268; }
        .nav-button.active { background: #007bff; }
        .button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .button:disabled { background: #6c757d; cursor: not-allowed; }
        .info-box { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center; }
        .month-section { border: 2px solid #007bff; padding: 15px; margin: 20px 0; border-radius: 8px; }
        .month-header { background: #007bff; color: white; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .day-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .day-header { background: #17a2b8; color: white; padding: 8px; border-radius: 3px; margin-bottom: 10px; }
        .assignment { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #28a745; border-radius: 5px; }
        .assignment-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .activity-code { font-weight: bold; font-size: 1.1em; color: #007bff; }
        .activity-desc { color: #495057; margin-left: 10px; }
        .assignment-category { background: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px; }
        .assignment-type { background: #17a2b8; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 5px; }
        .time-info { color: #666; font-size: 0.9em; margin: 5px 0; }
        .flight-info { background: #e7f3ff; padding: 10px; margin: 8px 0; border-radius: 4px; border-left: 3px solid #007bff; }
        .flight-header { font-weight: bold; color: #0056b3; margin-bottom: 5px; }
        .flight-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 0.85em; }
        .flight-detail { padding: 3px 0; }
        .flight-detail strong { color: #495057; }
        .status-advanced { color: #28a745; font-weight: bold; }
        .status-delayed { color: #dc3545; font-weight: bold; }
        .no-data { color: #6c757d; text-align: center; padding: 10px; }
        .error { color: #dc3545; text-align: center; padding: 20px; }
        .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; }
        .assignment-id { color: #999; font-size: 0.7em; float: right; }
        .current-day { border: 3px solid #ffc107; background: #fff3cd; }
        .actual-time { color: #dc3545; font-weight: bold; }
        .scheduled-time { color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è My Crew Schedule</h1>
            <div class="nav-buttons">
                <a href="/" class="nav-button active">üìã Schedule View</a>
                <a href="/calendar" class="nav-button">üìÖ Calendar View</a>
                <a href="/pdf" class="nav-button">üìÑ PDF Download</a>
            </div>
            <button class="button" onclick="fetchData()" id="refreshBtn">üîÑ Refresh Schedule</button>
        </div>

        {% if refresh_message %}
        <div class="success">
            {{ refresh_message }}
        </div>
        {% endif %}

        {% if last_fetch %}
        <div class="info-box">
            <h3>Last updated: {{ last_fetch }}</h3>
            <p>Total days: {{ total_days }} | Total assignments: {{ total_assignments }}</p>
            <p>Current Crew ID: <strong>{{ current_crew_id }}</strong></p>
        </div>
        {% endif %}

        {% if schedule_data %}
            {% for month in schedule_data %}
            <div class="month-section">
                <div class="month-header">
                    <h3>üìÖ {{ month_names[loop.index0] }}</h3>
                </div>
                {% for day in month %}
                    {% if day and day is mapping %}
                    <div class="day-card {% if day.StartDate[:10] == current_date %}current-day{% endif %}" id="day-{{ day.StartDate[:10] }}">
                        <div class="day-header">
                            <strong>{{ day.StartDate[:10] if day.StartDate else 'Unknown' }}</strong>
                            <span style="float: right;">DEM: {{ day.Dem }}</span>
                        </div>
                        
                        {% if day.AssignementList and day.AssignementList|length > 0 %}
                            {% for assignment in day.AssignementList %}
                            <div class="assignment">
                                <div class="assignment-header">
                                    <div>
                                        <span class="activity-code">{{ assignment.ActivityCode.strip() if assignment.ActivityCode else 'FLIGHT' }}</span>
                                        <span class="activity-desc">{{ assignment.ActivityDesc.strip() if assignment.ActivityDesc else 'Flight Duty' }}</span>
                                        {% if assignment.AssignementCategory %}
                                        <span class="assignment-category">{{ assignment.AssignementCategory }}</span>
                                        {% endif %}
                                        {% if assignment.ActivityType %}
                                        <span class="assignment-type">{{ assignment.ActivityType }}</span>
                                        {% endif %}
                                    </div>
                                    <span class="assignment-id">#{{ assignment.Id }}</span>
                                </div>
                                
                                <div class="time-info">
                                    <strong>üïê Time:</strong> 
                                    <span class="actual-time">{{ assignment.StartDateLocal[11:16] if assignment.StartDateLocal else 'N/A' }}</span> 
                                    to <span class="actual-time">{{ assignment.EndDateLocal[11:16] if assignment.EndDateLocal else 'N/A' }}</span>
                                    ({{ assignment.StartDateLocal[:10] if assignment.StartDateLocal else '' }})
                                </div>

                                {% if assignment.AircraftRegistrationNumber %}
                                <div class="time-info">
                                    <strong>‚úàÔ∏è Aircraft:</strong> {{ assignment.AircraftRegistrationNumber }}
                                    {% if assignment.Fleet %}({{ assignment.Fleet }}){% endif %}
                                </div>
                                {% elif assignment.Fleet %}
                                <div class="time-info">
                                    <strong>‚úàÔ∏è Fleet:</strong> {{ assignment.Fleet }}
                                </div>
                                {% endif %}

                                {% if assignment.FlighAssignement and assignment.FlighAssignement.CommercialFlightNumber != "XXX" %}
                                <div class="flight-info">
                                    <div class="flight-header">
                                        üõ´ Flight: {{ assignment.FlighAssignement.Airline }} {{ assignment.FlighAssignement.CommercialFlightNumber }}
                                    </div>
                                    
                                    <div class="flight-details">
                                        <div class="flight-detail">
                                            <strong>Route:</strong> {{ assignment.FlighAssignement.OriginAirportIATACode }} ‚Üí {{ assignment.FlighAssignement.FinalAirportIATACode }}
                                        </div>
                                        <div class="flight-detail">
                                            <strong>Duration:</strong> {{ assignment.FlighAssignement.Duration }} min (Scheduled: {{ assignment.FlighAssignement.ScheduledDuration }} min)
                                        </div>
                                        <div class="flight-detail">
                                            <strong>Departure:</strong> 
                                            <span class="scheduled-time">{{ assignment.FlighAssignement.ScheduledDepartureDate[11:16] if assignment.FlighAssignement.ScheduledDepartureDate else 'N/A' }}</span>
                                            {% if assignment.FlighAssignement.DepartureDate %}
                                            ‚Üí <span class="actual-time">{{ assignment.FlighAssignement.DepartureDate[11:16] if assignment.FlighAssignement.DepartureDate else 'N/A' }}</span>
                                            {% endif %}
                                            {% if assignment.FlighAssignement.DepartureStand %}
                                            | Stand: {{ assignment.FlighAssignement.DepartureStand }}
                                            {% endif %}
                                        </div>
                                        <div class="flight-detail">
                                            <strong>Arrival:</strong> 
                                            <span class="scheduled-time">{{ assignment.FlighAssignement.ScheduledArrivalDate[11:16] if assignment.FlighAssignement.ScheduledArrivalDate else 'N/A' }}</span>
                                            {% if assignment.FlighAssignement.ArrivalDate %}
                                            ‚Üí <span class="actual-time">{{ assignment.FlighAssignement.ArrivalDate[11:16] if assignment.FlighAssignement.ArrivalDate else 'N/A' }}</span>
                                            {% endif %}
                                            {% if assignment.FlighAssignement.ArrivalStand %}
                                            | Stand: {{ assignment.FlighAssignement.ArrivalStand }}
                                            {% endif %}
                                        </div>
                                        {% if assignment.FlighAssignement.TimeAdvanced or assignment.FlighAssignement.TimeDelayed %}
                                        <div class="flight-detail">
                                            <strong>Status:</strong>
                                            {% if assignment.FlighAssignement.TimeAdvanced %}
                                            <span class="status-advanced">Advanced</span>
                                            {% endif %}
                                            {% if assignment.FlighAssignement.TimeDelayed %}
                                            <span class="status-delayed">Delayed</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% if assignment.FlighAssignement.OriginAirportICAOCode or assignment.FlighAssignement.FinalAirportICAOCode %}
                                        <div class="flight-detail">
                                            <strong>ICAO Codes:</strong>
                                            {% if assignment.FlighAssignement.OriginAirportICAOCode %}
                                            {{ assignment.FlighAssignement.OriginAirportICAOCode }}
                                            {% endif %}
                                            {% if assignment.FlighAssignement.FinalAirportICAOCode %}
                                            ‚Üí {{ assignment.FlighAssignement.FinalAirportICAOCode }}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-data">No assignments for this day</div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        {% else %}
            <div class="error">
                <h3>No schedule data available</h3>
                <p>Click "Refresh Schedule" to load your schedule.</p>
            </div>
        {% endif %}
    </div>

    <script>
    function fetchData() {
        const button = document.getElementById('refreshBtn');
        button.disabled = true;
        button.textContent = '‚è≥ Loading...';
        
        fetch('/fetch?refresh=true')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const url = new URL(window.location);
                    url.searchParams.set('refresh', 'success');
                    window.location.href = url.toString();
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                    button.disabled = false;
                    button.textContent = 'üîÑ Refresh Schedule';
                }
            })
            .catch(err => {
                alert('Error: ' + err);
                button.disabled = false;
                button.textContent = 'üîÑ Refresh Schedule';
            });
    }

    // Scroll to current date on page load
    document.addEventListener('DOMContentLoaded', function() {
        const currentDayElement = document.querySelector('.current-day');
        if (currentDayElement) {
            currentDayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
    </script>
</body>
</html>
